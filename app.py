import streamlit as st
import google.generativeai as genai
import os

# -----------------------------------------------------------------------------
# 1. API í‚¤ ì„¤ì • (Rotation Logic) - app.pyì—ì„œ ê°€ì ¸ì˜´
# -----------------------------------------------------------------------------
# ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  API í‚¤ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
api_keys = []

# 1. Streamlit Secrets ìš°ì„  í™•ì¸
if "GOOGLE_API_KEY" in st.secrets:
    api_keys.append(st.secrets["GOOGLE_API_KEY"])
    # ì¶”ê°€ í‚¤ í™•ì¸ (GOOGLE_API_KEY_2, _3 ...)
    i = 2
    while f"GOOGLE_API_KEY_{i}" in st.secrets:
        api_keys.append(st.secrets[f"GOOGLE_API_KEY_{i}"])
        i += 1
else:
    # 2. í™˜ê²½ ë³€ìˆ˜ í™•ì¸ (ë¡œì»¬ í…ŒìŠ¤íŠ¸)
    key = os.getenv("GOOGLE_API_KEY")
    if key:
        api_keys.append(key)
        # ì¶”ê°€ í‚¤ í™•ì¸
        i = 2
        while os.getenv(f"GOOGLE_API_KEY_{i}"):
            api_keys.append(os.getenv(f"GOOGLE_API_KEY_{i}"))
            i += 1

# ê¸°ë³¸ í‚¤ë¡œ ì´ˆê¸° ì„¤ì • (í‚¤ê°€ ìˆì„ ê²½ìš°ì—ë§Œ)
if api_keys:
    genai.configure(api_key=api_keys[0])

def generate_content_with_rotation(prompt, model_name="gemini-3-flash-preview"):
    """
    API í‚¤ë¥¼ ìˆœí™˜í•˜ë©° ì»¨í…ì¸  ìƒì„±ì„ ì‹œë„í•©ë‹ˆë‹¤.
    Rate Limit ë°œìƒ ì‹œ ë‹¤ìŒ í‚¤ë¡œ ìë™ ì „í™˜í•©ë‹ˆë‹¤.
    """
    if not api_keys:
        raise Exception("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    last_error = None
    
    for i, key in enumerate(api_keys):
        try:
            # í˜„ì¬ í‚¤ë¡œ ì„¤ì • ë° ìƒì„± ì‹œë„
            genai.configure(api_key=key)
            model = genai.GenerativeModel(model_name)
            response = model.generate_content(prompt)
            return response.text
            
        except Exception as e:
            last_error = e
            # Quota ê´€ë ¨ ì—ëŸ¬ì¸ ê²½ìš° ë‹¤ìŒ í‚¤ ì‹œë„
            error_str = str(e)
            if "429" in error_str or "Quota" in error_str or "Resource exhausted" in error_str:
                # ë§ˆì§€ë§‰ í‚¤ê°€ ì•„ë‹ˆë©´ ë‹¤ìŒ í‚¤ë¡œ ê³„ì†
                if i < len(api_keys) - 1:
                    continue
            
            # ê·¸ ì™¸ ì—ëŸ¬ê±°ë‚˜ ë§ˆì§€ë§‰ í‚¤ë©´ ë£¨í”„ ì¢…ë£Œ
            break
            
    # ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë°œìƒ
    raise last_error

# -----------------------------------------------------------------------------
# 2. FAQ ë°ì´í„° ì •ì˜
# -----------------------------------------------------------------------------
faq_data = """
[ë¡œë³´ì–´ë“œë°”ì´ì € ì„œë¹„ìŠ¤ ìƒì„¸ ë§¤ë‰´ì–¼]

### 1. ì„œë¹„ìŠ¤ ê¸°ëŠ¥ ë° ê¸°ë³¸ ì›ì¹™
- **ê°€ì… ë° ì„¤ê³„**: ê°€ì…ê³¼ ë™ì‹œì— ë§ì¶¤ì„¤ê³„ê°€ ì§„í–‰ë˜ëŠ” ê²ƒì´ ì•„ë‹ˆë©°, ê³ ê°ì´ ê°€ì… í›„ ì§ì ‘ ë§ì¶¤ì„¤ê³„ë¥¼ ì§„í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” ê³ ê°ì—ê²Œ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ 'ì¶”ì²œ'ë“œë¦¬ëŠ” ì„œë¹„ìŠ¤ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
- **íˆ¬ìì„±í–¥**: íˆ¬ììì„±í–¥ê³¼ ìƒê´€ì—†ì´ ê°€ì…ì€ ê°€ëŠ¥í•˜ë©°, ìµœì¢…ì—ëŠ” ë³¸ì¸ íˆ¬ìì„±í–¥ì— ë”°ë¥¸ í¬íŠ¸í´ë¦¬ì˜¤ ìœ í˜•ì´ ì„ íƒë˜ì§€ë§Œ íƒ€ ìœ í˜•ë„ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë‹¨, ë§ì¶¤ì„¤ê³„ ê³¼ì •ì—ì„œ íˆ¬ìë¶€ì í•©ì„± ì•ˆë‚´, ì•½ê´€ë™ì˜ ë“± í•„ìˆ˜ ê³ ì§€ì‚¬í•­ í”„ë¡œì„¸ìŠ¤ê°€ ì¶”ê°€ ë°œìƒí•©ë‹ˆë‹¤.
- **í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ìˆ˜ì •**: íˆ¬ììê°€ ì„ì˜ë¡œ ìì‚°êµ° ë¹„ì¤‘ì„ ìˆ˜ì •í•˜ê±°ë‚˜ ì¼ë¶€ í€ë“œë§Œ êµì²´í•˜ê²Œ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í‡´ì§ì—°ê¸ˆì˜ ìœ„í—˜ìì‚°ë¹„ìœ¨ ì¤€ìˆ˜ë¥¼ ìœ„í•´ ë¡œë³´ì–´ë“œë°”ì´ì €ê°€ ë§¤ë§¤ ì‹œ ìë™ìœ¼ë¡œ ë¹„ì¤‘ ì¤€ìˆ˜ë¥¼ ìœ„í•œ ë§¤ë§¤ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
- **í€ë“œ êµì²´ ë²”ìœ„**: ì›ì¹™ì ìœ¼ë¡œ ê³ ê°ì´ ê°€ì§€ê³  ê³„ì‹  ê³µëª¨í€ë“œ ì „ì²´ê°€ êµì²´ ëŒ€ìƒì…ë‹ˆë‹¤. ë‹¨, ë¡œë³´ì–´ë“œë°”ì´ì €ê°€ íŒë‹¨í•˜ê¸°ì— 1ìœ„ ìƒí’ˆê³¼ ì„±ëŠ¥ì´ ìœ ì‚¬í•œ í€ë“œëŠ” ì¼ë¶€ë§Œ ë§¤ë§¤ë  ìˆ˜ ìˆìœ¼ë©°, ê±°ë˜ ë²”ì£¼ì—ì„œ ì œì™¸ë˜ëŠ” í•­ëª©ì€ ë§¤ë§¤ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.

### 2. ê°€ì… ë¶ˆê°€ ìš”ê±´ ìƒì„¸ (ê° ê³„ì¢Œë³„)
- **í‡´ì§ì—°ê¸ˆ**: MPêµ¬ë… ì„œë¹„ìŠ¤ ì´ìš© ê³„ì¢Œ ë“±.
- **ê°œì¸ì—°ê¸ˆ**: ì—°ê¸ˆê°œì‹œ ì •ê¸°ì§€ê¸‰ ê³„ì¢Œ(ì„ì˜ì‹ì€ ê°€ëŠ¥), ëŒ€ì¶œ ì•½ì •ê³„ì¢Œ, ì—°ê¸ˆì €ì¶•ê³„ì¢Œ ì •ê¸°ë§¤ë„ ì•½ì •ê³„ì¢Œ, ìë™ëŒ€ì²´ì…ê¸ˆë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, CMSìë™ëŒ€ì²´ì…ê¸ˆë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, í€ë“œ ì •ê¸°ìë™ë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, ì´ì „ìš© ê³„ì¢Œ, ì´ê´€ì‹ ì²­ì¤‘ ê³„ì¢Œ, ì‚¬ê³ ê³„ì¢Œ(ë§¤ë§¤ì œí•œ) ë° ì¥ê¸°ë¯¸ì‚¬ìš© ê³„ì¢Œ. íƒ€ ì„œë¹„ìŠ¤ ì´ìš© ì¤‘ì¸ ê²½ìš°(ê°œì¸ì—°ê¸ˆ ë©, ê°œì¸ì—°ê¸ˆ ìë¬¸, ì ë¦½ì‹ ìë™ë§¤ìˆ˜ ì„œë¹„ìŠ¤-ì—°ê¸ˆ ëª¨ìœ¼ê¸°) ê°€ì… ë¶ˆê°€.
- **ISA**: ê³„ì¢Œí•´ì§€ ì‹ ì²­ì¤‘ ë° ì´í›„ë‹¨ê³„ ê³„ì¢Œ, ìë™ëŒ€ì²´ì…ê¸ˆë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, CMSìë™ëŒ€ì²´ì…ê¸ˆë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, í€ë“œ ì •ê¸°ìë™ë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, ì‚¬ê³ ê³„ì¢Œ(ë§¤ë§¤ì œí•œ), ì ë¦½ì‹ ìë™ë§¤ìˆ˜ ì„œë¹„ìŠ¤, ì´ê´€ì‹ ì²­ì ‘ìˆ˜/ì´ê´€í•´ì§€ì‹ ì²­ ê³„ì¢Œ, ë§Œê¸°ì´ˆê³¼ ê³„ì¢Œ.
- **ì¼ë°˜ê³„ì¢Œ**: ê³„ì¢Œí•´ì§€ ì‹ ì²­ì¤‘ ë° ì´í›„ë‹¨ê³„ ê³„ì¢Œ, ìë™ëŒ€ì²´ì…ê¸ˆë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, CMSìë™ëŒ€ì²´ì…ê¸ˆë§¤ìˆ˜ ì•½ì •ê³„ì¢Œ, ì‚¬ê³ ê³„ì¢Œ(ë§¤ë§¤ì œí•œ), ì ë¦½ì‹ ìë™ë§¤ìˆ˜ ì„œë¹„ìŠ¤, ì´ê´€ì‹ ì²­ì ‘ìˆ˜/ì´ê´€í•´ì§€ì‹ ì²­ ê³„ì¢Œ, ë§Œê¸°ì´ˆê³¼ ê³„ì¢Œ, ì‹ ìš©/ëŒ€ì¶œ/ëŒ€ì—¬/ì œíœ´ ì•½ì •ê³„ì¢Œ, ê³µëª¨ë¶€ë™ì‚°ë¶„ë¦¬ê³¼ì„¸ ì•½ì •, ë¶„ë¦¬ê³¼ì„¸í•˜ì´ì¼ë“œ ì•½ì •, ë¶„ë¦¬ê³¼ì„¸ê³ ìœ„í—˜ê³ ìˆ˜ìµí€ë“œ ì•½ì •, ì›”ì§€ê¸‰ ì•½ì •, ê³„ì¢Œì¦ê±°ê¸ˆë¥  100% ì™¸, í•´ì™¸ì£¼ì‹ ê³„ì¢Œì¦ê±°ê¸ˆë¥  100% ì™¸, ê³„ì¢Œìœ„íƒì¦ê±°ê¸ˆ ë¯¸ì§•ìˆ˜, ë§¤ë§¤í—ˆìš© ìœ ê°€ì¦ê¶Œ 'í€ë“œ' ë¯¸ë“±ë¡ ê³„ì¢Œ. ë©ê³„ì•½ ì•½ì •ê³„ì¢Œ, ìë¬¸ì‚¬ ì¼ì„/ìë¬¸ ê³„ì¢Œ ì´ìš© ì‹œ ë¶ˆê°€.
- **ë¹„ê³¼ì„¸ì¢…í•©ì €ì¶•**: ìœ„ ì¼ë°˜ê³„ì¢Œ ìš”ê±´ê³¼ ë™ì¼í•¨.

### 3. ë§ì¶¤ì„¤ê³„ ì´ìš© ì œí•œ ì—¬ë¶€ ë° ì œì™¸ ìƒí’ˆ (MAPIS ê¸°ì¤€)
- **ì •ìƒ ìƒíƒœ ê¸°ì¤€ (MAPIS 7895, 8525)**: 
  * íˆ¬ììì„±í–¥: ì„±ì¥í˜•, ì„±ì¥ì¶”êµ¬í˜• ë“± (ì•ˆì •ì¶”êµ¬í˜• ë“± ë¶€ì í•© ì‹œ 'í•´ë‹¹'ìœ¼ë¡œ í‘œì‹œë¨)
  * íˆ¬ìê¶Œìœ : 'í¬ë§' ìƒíƒœì—¬ì•¼ í•¨
  * ìš´ìš©ê°€ëŠ¥ê¸ˆì•¡: 10,000ì› ì´ìƒ
  * ìœ„í—˜ìì‚°ë¹„ìœ¨: í‡´ì§ì—°ê¸ˆì˜ ê²½ìš° 70% ì´í•˜
  * ë³´ìœ ìƒí’ˆê°¯ìˆ˜: í‡´ì§ì—°ê¸ˆ 20ê°œ ë¯¸ë§Œ, ê°œì¸ì—°ê¸ˆ/ISA ë“± 50ê°œ ì´í•˜
- **ìš´ìš© ë° í‰ê°€ ì œì™¸ í€ë“œ ë¦¬ìŠ¤íŠ¸**: ì•„ë˜ í€ë“œëŠ” í€ë“œí‰ê°€ê¸ˆì•¡ ë° ìš´ìš©ê°€ëŠ¥ê¸ˆì•¡ ì§‘ê³„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
  1) ê±°ë˜ë¶ˆê°€í€ë“œ (ì˜ˆ: ëŸ¬ì‹œì•„ í€ë“œ ë“±)
  2) í™˜ë§¤ìˆ˜ìˆ˜ë£Œ ë°œìƒ í€ë“œ
  3) ì‚¬ëª¨í€ë“œ
  4) ì˜¤í”„ë¼ì¸ì „ìš©í€ë“œ
  5) í™˜ë§¤ê¸ˆì§€í€ë“œ
  6) ì„±ê³¼ë³´ìˆ˜ í€ë“œ
  7) ì½”ìŠ¤ë‹¥ë²¤ì²˜ í€ë“œ
  8) ìˆ™ë ¤ëŒ€ìƒ í€ë“œ

### 4. 2026/1/1 ìµœì‹  ì œí•œ ë° ì—…ë°ì´íŠ¸ ì‚¬í•­
- **í˜„ì¬ìê¸ˆíˆ¬ìì„±í–¥ ì œí•œ**: Q1 'ë‹¨ê¸° ìƒê³„ ìê¸ˆ' í˜¹ì€ Q2 'ì›ê¸ˆ ë³´ì¡´ ì¶”êµ¬' ë‹µë³€ ì¤‘ í•˜ë‚˜ë¼ë„ ì²´í¬ëœ ê²½ìš° ì´ìš© ë¶ˆê°€. (MAPIS 3250ì—ì„œ í™•ì¸ ë° ì¬ì§„ë‹¨ í•„ìš”)
- **ISA í•´ì§€ ê´€ë ¨**: ISA ë¶€ì í•© ìš”ê±´ ë°œìƒ í˜¹ì€ ê³„ì¢Œ ì´ì „ ì‹ ì²­ ì‹œ, í•´ë‹¹ ê³„ì¢Œì˜ ë¡œë³´ì–´ë“œë°”ì´ì € ê°€ì…ì„ ì‚¬ì „ì ìœ¼ë¡œ í•´ì§€í•´ì•¼ ì—…ë¬´ ì§„í–‰ì´ ê°€ëŠ¥í•¨.
- **íˆ¬ìì„¤ëª…ì„œ ë°œì†¡ (25/10/24 ì¶”ê°€)**:
  * í‡´ì§ì—°ê¸ˆ: ë§ì¶¤ì„¤ê³„ ì™„ë£Œ ì§í›„ 1íšŒë§Œ ì•Œë¦¼í†¡ ë°œì†¡.
  * ê°œì¸ì—°ê¸ˆ/ISA/ì¼ë°˜: ë§¤ìˆ˜ë˜ëŠ” í€ë“œë§ˆë‹¤ ë§¤ìˆ˜ ì‹œì ì— ê°œë³„ íˆ¬ìì„¤ëª…ì„œ ë°œì†¡.

### 5. ë§¤ë§¤, ìˆ˜ìµë¥  ë° ì•Œë¦¼ ê·œì¹™
- **ë§¤ë§¤ ë¶ˆê°€ ì‹œê°„**: 23ì‹œ 55ë¶„ ~ 24ì‹œ 05ë¶„ (ì£¼ë¬¸ ì œì¶œ ì‹œ ì‹¤íŒ¨ ë° ì „ì²´ ì·¨ì†Œ ì²˜ë¦¬).
- **ë¦¬ë°¸ëŸ°ì‹± ì•Œë¦¼**: ìˆ˜ì‹œ(ì§ì „ ìŠ¹ì¸ 5ì˜ì—…ì¼ ê²½ê³¼ ë° ë¹„ì¤‘ ì°¨ì´ ë°œìƒ ì‹œ, ì•½ 14ì¼ ì£¼ê¸° ê²€ì¶œ), ì •ê¸°(ìµœì¢… ìŠ¹ì¸ í›„ 40ì˜ì—…ì¼ ê²½ê³¼ ì‹œ).
- **ìˆ˜ìµë¥  í™•ì¸ ë¶ˆê°€ ì‚¬ìœ **: ê³„ì¢Œ ë‚´ ë¡œë³´ ë¯¸ìš´ìš© ìƒí’ˆ(ì˜ˆê¸ˆ, ELB, ETF ë“±) ì¡´ì¬ë¡œ ì¸í•œ í˜¼ë™ ë°©ì§€ ë° ê³ ê° ì˜ì‚¬(ìŠ¹ì¸/ê±°ì ˆ) ê°œì…ì— ë”°ë¥¸ ì„±ê³¼ ì°¨ì´ ë•Œë¬¸.
- **ì„±ê³¼ í™•ì¸ ê²½ë¡œ**: [MY ë¡œë³´ì–´ë“œë°”ì´ì € > ê³„ì¢Œí˜„í™© > ë³´ìœ í€ë“œ] ë˜ëŠ” [MY í€ë“œ] í™”ë©´.

### 6. ì£¼ìš” ì—ëŸ¬ ì‚¬ë¡€ (Error Case)
1) **ì†Œìˆ˜ì  ì²˜ë¦¬**: í‡´ì§ì—°ê¸ˆì—ì„œ ì•„ì£¼ ì ì€ ê¸ˆì•¡ íˆ¬ì ì‹œ ë¹„ì¤‘ ë‹¨ìœ„ê°€ ì •ìˆ˜ì´ê¸° ë•Œë¬¸ì— 'ë§¤ë„ ìƒí’ˆ ì—†ìŒ' ì—ëŸ¬ ë°œìƒ ê°€ëŠ¥.
2) **ìœ„í—˜ìì‚° ë¹„ì¤‘ ì‹œì°¨**: ë‹¹ì¼ ë§¤ë§¤ë¡œ ìœ„í—˜ìì‚°ë¹„ìœ¨ 70% ì´ˆê³¼ ìƒíƒœì—ì„œ ì„¤ê³„ ì‹œ ì¥ì•  ë°œìƒ. ê²°ì œ ì™„ë£Œ ì‹œê¹Œì§€ ëŒ€ê¸° í•„ìš”.
3) **ì¤‘ë³µ í”„ë¡œì„¸ìŠ¤**: 'í¬íŠ¸í´ë¦¬ì˜¤ ë³€ê²½ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤' íŒì—… ì‹œ ê¸°ì¡´ ë§¤ë§¤ ìŠ¤ì¼€ì¤„ ì·¨ì†Œ í›„ ì¬ì§„í–‰.
4) **ë¯¸êµ­ êµ­ì ì**: ë§¤ë§¤ ë¶ˆê°€ í€ë“œ í¬í•¨ ì‹œ ë§ì¶¤ì„¤ê³„ ë‹¨ê³„ì—ì„œ ì—ëŸ¬.
5) **í‡´ì‚¬ í›„ DC ê³„ì¢Œ**: ê°€ì…ì ë²ˆí˜¸ê°€ ë‚¨ì•„ í™”ë©´ ì§„ì…ì€ ê°€ëŠ¥í•˜ë‚˜ ì„¤ê³„ ì‹œ ì—ëŸ¬ ë°œìƒ (ì°¨ì„¸ëŒ€ ì´í›„ ìˆ˜ì • ì˜ˆì •).
"""

# -----------------------------------------------------------------------------
# 3. ëª¨ë¸ ì„¤ì • (System Prompt)
# -----------------------------------------------------------------------------
system_prompt = f"""
ë‹µë³€ì˜ 1ìˆœìœ„ ê·¼ê±°ëŠ” ì œê³µëœ **[FAQ ë°ì´í„°]**ì…ë‹ˆë‹¤.
ë§Œì•½ FAQì— ì—†ëŠ” ë‚´ìš© ì¤‘ ì¼ë°˜ì ì¸ ê¸ˆìœµ ì§€ì‹ì€ ë‹¹ì‹ ì˜ ê¸°ë³¸ ì§€ì‹ì„ í™œìš©í•´ ì„¤ëª…í•˜ë˜, ë¯¸ë˜ì—ì…‹ì˜ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë‚˜ ì •ì±…ì€ ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”.
ë¯¼ê°í•œ íˆ¬ì ê¶Œìœ  ì§ˆë¬¸ì—ëŠ” FAQì˜ ê³µì‹ ì…ì¥ì„ ì „ë‹¬í•˜ì„¸ìš”.
ì¼ë°˜ì ì¸ ì§€ì‹ì´ ì•„ë‹ˆê³ , [FAQ ë°ì´í„°]ì— ì—†ëŠ” ë‚´ìš©ì´ë¼ë©´ "ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ë‚´ìš©ì€ ê³ ê°ì„¼í„°(1588-XXXX)ë¡œ ë¬¸ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤"ë¼ê³  ë‹µë³€í•˜ì„¸ìš”."
[FAQ ë°ì´í„°]
{faq_data}
"""

# -----------------------------------------------------------------------------
# 4. ì›¹ í™”ë©´ UI êµ¬ì„± (Streamlit)
# -----------------------------------------------------------------------------
st.set_page_config(page_title="ë¡œë³´ì–´ë“œë°”ì´ì € ì±—ë´‡", page_icon="ğŸ¤–", layout="wide")

# OP.GG ìŠ¤íƒ€ì¼ ì»¤ìŠ¤í…€ CSS ì ìš© (Light Theme)
st.markdown(
    """
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        html, body, [class*="css"] {
            font-family: 'Noto Sans KR', sans-serif;
        }

        /* ë©”ì¸ ë°°ê²½ìƒ‰ - OP.GGì˜ ë°ì€ íšŒìƒ‰/ë¸”ë£¨ í†¤ */
        .stApp {
            background-color: #ecf2f5;
            color: #23292f; /* ì§™ì€ íšŒìƒ‰ í…ìŠ¤íŠ¸ */
        }

        /* ì‚¬ì´ë“œë°” ë°°ê²½ìƒ‰ - OP.GGì˜ ì§™ì€ ë„¤ì´ë¹„ (í—¤ë” ëŠë‚Œ) */
        [data-testid="stSidebar"] {
            background-color: #1c2836;
        }
        
        /* ì‚¬ì´ë“œë°” ë‚´ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ì¡°ì • */
        [data-testid="stSidebar"] h1, [data-testid="stSidebar"] h2, [data-testid="stSidebar"] h3, [data-testid="stSidebar"] label, [data-testid="stSidebar"] p {
            color: #ffffff !important;
        }

        /* í—¤ë” ë°°ê²½ìƒ‰ */
        [data-testid="stHeader"] {
            background-color: rgba(0,0,0,0);
        }

        /* ì œëª© ìƒ‰ìƒ (OP.GG ë¸Œëœë“œ ë¸”ë£¨ í¬ì¸íŠ¸) */
        h1 {
            color: #5383e8 !important;
            font-weight: 700;
        }
        h2, h3 {
            color: #23292f !important;
        }

        /* ì±„íŒ… ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ (í™”ì´íŠ¸ ë°•ìŠ¤) */
        div[data-testid="stChatInput"] > div {
            background-color: #ffffff !important;
            border: 1px solid #dce2f0 !important;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* ì…ë ¥ì°½ í…ìŠ¤íŠ¸ ì˜ì—­ */
        div[data-testid="stChatInput"] textarea {
            background-color: transparent !important;
            color: #23292f !important; 
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ë¸Œëœë“œ ë¸”ë£¨) */
        .stButton button {
            background-color: #5383e8;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }
        .stButton button:hover {
            background-color: #426cb7;
            color: white;
        }

        /* ì‚¬ìš©ì/AI ë©”ì‹œì§€ êµ¬ë¶„ê° */
        [data-testid="chatAvatarIcon-user"] {
            background-color: #5383e8;
        }
        [data-testid="chatAvatarIcon-assistant"] {
            background-color: #ffb900; /* AIëŠ” ë…¸ë€ìƒ‰ í¬ì¸íŠ¸ */
        }
    </style>
    """,
    unsafe_allow_html=True
)

st.title("ğŸ¤– ë¡œë³´ì–´ë“œë°”ì´ì € ìƒë‹´")
st.caption("FAQ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ë‹µë³€í•´ ë“œë¦½ë‹ˆë‹¤.")

# API í‚¤ í™•ì¸
if not api_keys:
    st.error("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .streamlit/secrets.toml ë˜ëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.")
    st.stop()

if "messages" not in st.session_state:
    st.session_state.messages = []

# ê¸°ì¡´ ëŒ€í™” ê¸°ë¡ í‘œì‹œ
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# ì¶”ì²œ ì§ˆë¬¸ (FAQ) ì˜ì—­
faq_keywords = [
    "ì„œë¹„ìŠ¤ ê°€ì…/ì„¤ê³„",
    "í¬íŠ¸í´ë¦¬ì˜¤ ë¹„ì¤‘ ìˆ˜ì •",
    "í‡´ì§ì—°ê¸ˆ ê°€ì…ì œí•œ",
    "ê°œì¸ì—°ê¸ˆ ê°€ì…ì œí•œ",
    "ë§¤ë§¤/ë¦¬ë°¸ëŸ°ì‹± ê·œì¹™",
    "ìˆ˜ìµë¥  ë¯¸ë…¸ì¶œ ì‚¬ìœ ",
    "ì£¼ìš” ì—ëŸ¬ ì‚¬ë¡€"
]

with st.expander("ğŸ’¡ ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (ì¶”ì²œ í‚¤ì›Œë“œ)"):
    st.caption("ê¶ê¸ˆí•œ ë‚´ìš©ì„ í´ë¦­í•´ë³´ì„¸ìš”.")
    cols = st.columns(4) # 4ì—´ë¡œ ë°°ì¹˜
    for i, keyword in enumerate(faq_keywords):
        if cols[i % 4].button(keyword, key=f"faq_{i}"):
            st.session_state.messages.append({"role": "user", "content": f"{keyword}ì— ëŒ€í•´ ì•Œë ¤ì¤˜"})
            st.rerun()

# ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥
if prompt := st.chat_input("ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

# ë‹µë³€ ìƒì„± ë¡œì§
if st.session_state.messages and st.session_state.messages[-1]["role"] == "user":
    with st.chat_message("assistant"):
        with st.spinner("ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."):
            try:
                # ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ ê°€ì ¸ì˜¤ê¸°
                last_user_msg = st.session_state.messages[-1]["content"]
                
                # API Key Rotation ì ìš©
                # ëª¨ë¸ëª…ì€ ìµœì‹  ëª¨ë¸ ì‚¬ìš© ê¶Œì¥ (gemini-1.5-flash)
                full_prompt = f"ì§ˆë¬¸: {last_user_msg}\n\në‹µë³€ (í•œêµ­ì–´ë¡œ, ê¸ˆìœµ ì „ë¬¸ê°€ì²˜ëŸ¼):"
                response_text = generate_content_with_rotation(full_prompt, model_name="gemini-3-flash-preview")
                
                st.markdown(response_text)
                st.session_state.messages.append({"role": "assistant", "content": response_text})
                
            except Exception as e:
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
