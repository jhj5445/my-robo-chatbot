import streamlit as st
import google.generativeai as genai
import os
import glob
import re
import streamlit.components.v1 as components


# 1. API í‚¤ ì„¤ì • (Google AI Studioì—ì„œ ë°œê¸‰ë°›ì€ í‚¤ ì…ë ¥)
GOOGLE_API_KEY = "AIzaSyBbYUnSBp32fVzTiTlVRcN1GE9JK2BrLKs"
genai.configure(api_key=GOOGLE_API_KEY)

# 2. FAQ ë°ì´í„° ì •ì˜ (ì—¬ê¸°ì— ì¤€ë¹„í•˜ì‹  FAQ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ë„£ìœ¼ì„¸ìš”)
faq_data = """
[ë¡œë³´ì–´ë“œë°”ì´ì € ì„œë¹„ìŠ¤ ë§ˆìŠ¤í„° ë§¤ë‰´ì–¼]

### 1. ì„œë¹„ìŠ¤ ì§„ì… ê²½ë¡œ ë° ê°€ì…
- **MTS ì§„ì… ê²½ë¡œ**: 
  1) [ë©”ë‰´ > ì—°ê¸ˆ > ì—°ê¸ˆ í¬íŠ¸í´ë¦¬ì˜¤ > ì—°ê¸ˆ ë¡œë³´ì–´ë“œë°”ì´ì €]
  2) [ë©”ë‰´ > ìƒí’ˆ > ë¡œë³´ì–´ë“œë°”ì´ì €]
  3) [ë©”ë‰´ > ìƒí’ˆ > ISA > ISA ë¡œë³´ì–´ë“œë°”ì´ì €]
- **ê°€ì… ì›ì¹™**: ì„œë¹„ìŠ¤ ê°€ì…ì€ 'ì¶”ì²œ'ì„ ë°›ê¸° ìœ„í•œ ì¤€ë¹„ ë‹¨ê³„ì´ë©°, ì‹¤ì œ ìš´ìš©ì„ ìœ„í•´ì„œëŠ” ê°€ì… í›„ ë°˜ë“œì‹œ [ë§ì¶¤ì„¤ê³„] ë‹¨ê³„ê¹Œì§€ ì™„ë£Œí•´ì•¼ í¬íŠ¸í´ë¦¬ì˜¤ê°€ ìƒì„±ë©ë‹ˆë‹¤.
- **ì‚¬ì´ë²„ ë“±ë¡**: ì—°ê¸ˆê³„ì¢Œ ë³´ìœ  ì¤‘ì´ë‚˜ ê°€ì… ê°€ëŠ¥ ê³„ì¢Œê°€ ì—†ë‹¤ê³  ëœ° ê²½ìš°, MTSì—ì„œ 'ì‚¬ì´ë²„ ë“±ë¡ ì—¬ë¶€'ë¥¼ ë°˜ë“œì‹œ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

### 2. í•´ì§€ ë° ìˆ˜ë™ ë§¤ë§¤ ì£¼ì˜ì‚¬í•­ (UI ê²½ë¡œ í¬í•¨)
- **í•´ì§€ ë°©ë²•**: **MY ë¡œë³´ì–´ë“œë°”ì´ì € í™”ë©´ ìš°ì¸¡ ìƒë‹¨ì˜ ëŠë‚Œí‘œ(!) ë²„íŠ¼ì„ í´ë¦­í•œ í›„, íŒì—…ì°½ í•˜ë‹¨ì˜ [ì„œë¹„ìŠ¤ í•´ì§€] ë²„íŠ¼**ì„ ëˆŒëŸ¬ì•¼ í•©ë‹ˆë‹¤.
- **ë§¤ë§¤ ì·¨ì†Œ ê´€ê³„**: ì„œë¹„ìŠ¤ í•´ì§€ ì‹œ, ì´ë¯¸ ì‹ ì²­ëœ(ì²´ê²° ì „) ë§¤ë§¤ ì£¼ë¬¸ì´ ìë™ìœ¼ë¡œ ì·¨ì†Œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê³ ê°ì´ ì§ì ‘ [í€ë“œ ë§¤ë§¤ ì·¨ì†Œ] ë©”ë‰´ì—ì„œ ê±´ë³„ë¡œ ì·¨ì†Œí•´ì•¼ í•©ë‹ˆë‹¤.
- **ìˆ˜ë™ ë§¤ë§¤**: ë¡œë³´ì–´ë“œë°”ì´ì € ì´ìš© ì¤‘ ê³ ê°ì´ ì„ì˜ë¡œ í•´ë‹¹ ê³„ì¢Œì—ì„œ í€ë“œë¥¼ ë§¤ìˆ˜/ë§¤ë„í•  ê²½ìš°, ë¡œë³´ê°€ ì„¤ì •í•œ ë¹„ì¤‘ê³¼ ì–´ê¸‹ë‚˜ê²Œ ë˜ì–´ ë‹¤ìŒ ë¦¬ë°¸ëŸ°ì‹± ì‹œ ëŒ€ê·œëª¨ ë§¤ë§¤ê°€ ë°œìƒí•˜ê±°ë‚˜ ì—ëŸ¬ê°€ ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 3. ë§ì¶¤ì„¤ê³„ ì œí•œ ë° ì˜ˆì™¸ ì¡°ê±´ (MAPIS ìƒì„¸)
- **ë§ì¶¤ì„¤ê³„ ì œí•œ ì—¬ë¶€ í•­ëª© (MAPIS 7895, 8525)**: 
  * íˆ¬ììì„±í–¥: ì„±ì¥í˜•, ì„±ì¥ì¶”êµ¬í˜• ë“± (ì•ˆì •ì¶”êµ¬í˜• ë“± ë¶€ì í•© ì‹œ 'í•´ë‹¹'ìœ¼ë¡œ í‘œì‹œë¨)
  * íˆ¬ìê¶Œìœ : 'í¬ë§' ìƒíƒœì—¬ì•¼ í•¨ (ë¶€í¬ë§ ì‹œ ì„¤ê³„ ë¶ˆê°€)
  * ìš´ìš©ê°€ëŠ¥ê¸ˆì•¡: ìµœì†Œ 10,000ì› ì´ìƒ
  * ìœ„í—˜ìì‚°ë¹„ìœ¨: í‡´ì§ì—°ê¸ˆ ê¸°ì¤€ 70% ì´í•˜ (ì´ˆê³¼ ì‹œ ì„¤ê³„ ì¥ì• )
  * ë³´ìœ ìƒí’ˆê°¯ìˆ˜: í‡´ì§ì—°ê¸ˆ 20ê°œ ë¯¸ë§Œ, ê°œì¸ì—°ê¸ˆ/ISA/ì¼ë°˜ 50ê°œ ì´í•˜
- **ìš´ìš© ë° í‰ê°€ ì œì™¸ ìƒí’ˆ**: ì•„ë˜ ìƒí’ˆì€ ë¡œë³´ ìš´ìš© ê¸ˆì•¡ ì§‘ê³„ì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.
  - ê±°ë˜ë¶ˆê°€í€ë“œ(ëŸ¬ì‹œì•„ ë“±), í™˜ë§¤ìˆ˜ìˆ˜ë£Œ ë°œìƒ í€ë“œ, ì‚¬ëª¨í€ë“œ, ì˜¤í”„ë¼ì¸ ì „ìš© í€ë“œ, í™˜ë§¤ê¸ˆì§€ í€ë“œ, ì„±ê³¼ë³´ìˆ˜ í€ë“œ, ì½”ìŠ¤ë‹¥ë²¤ì²˜ í€ë“œ, ìˆ™ë ¤ëŒ€ìƒ í€ë“œ.
- **2026/1/1 ì‹ ê·œ ì œí•œ**: ìê¸ˆíˆ¬ìì„±í–¥(MTS ì§„ë‹¨) ì¤‘ 'ë‹¨ê¸° ìƒê³„ ìê¸ˆ' ë˜ëŠ” 'ì›ê¸ˆ ë³´ì¡´ ì¶”êµ¬' ì„ íƒ ì‹œ ì´ìš© ë¶ˆê°€ (MAPIS 3250 í™•ì¸).

### 4. ë§¤ë§¤ ë° ë¦¬ë°¸ëŸ°ì‹± ìƒì„¸ ë¡œì§
- **ë§¤ë§¤ ì‹œê°„ ì œí•œ**: 23:55 ~ 24:05 (ì´ ì‹œê°„ ì£¼ë¬¸ ì œì¶œ ì‹œ 'ì œì¶œ ì‹¤íŒ¨' íŒì—…ê³¼ í•¨ê»˜ ì „ì²´ ì·¨ì†Œë¨).
- **ë¦¬ë°¸ëŸ°ì‹± ì£¼ê¸°**: ìˆ˜ì‹œ(ì§ì „ ìŠ¹ì¸ 5ì˜ì—…ì¼ ê²½ê³¼ ë° ë¹„ì¤‘ ì°¨ì´ ê°ì§€ ì‹œ, ì•½ 14ì¼ ì£¼ê¸°), ì •ê¸°(ìµœì¢… ìŠ¹ì¸ í›„ 40ì˜ì—…ì¼ ê²½ê³¼ ì‹œ).
- **ë¡œë³´ì œì•ˆ vs ê³ ê°ì£¼ë„**: 
  * ë¡œë³´ì œì•ˆ: ì•Œë¦¼í†¡/ë°°ë„ˆë¡œ ìœ ì…. ê°€ì… ë‹¹ì‹œ ì„ íƒí•œ ìœ í˜•ì´ ê°•ì œ ìœ ì§€ë¨.
  * ê³ ê°ì£¼ë„: MY í™”ë©´ í•˜ë‹¨ ë²„íŠ¼ìœ¼ë¡œ ì§„ì…. ìœ í˜• ë³€ê²½ì´ ê°€ëŠ¥í•¨.
- **ê²°ì œ ì‹œì°¨ ì£¼ì˜**: ë‹¹ì¼ í€ë“œ ë§¤ë„/ë§¤ìˆ˜ ê±´ì´ ìˆëŠ” ê²½ìš°, 'ê²°ì œ'ê°€ ì™„ë£Œë˜ì–´ ì‹¤ì”ê³ ì— ë°˜ì˜ë˜ê¸° ì „ê¹Œì§€ëŠ” ë¡œë³´ ì„¤ê³„ ì‹œ ë¹„ì¤‘ ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (T+nì¼ ì†Œìš”).

### 5. ìˆ˜ìµë¥  ë° ì„±ê³¼ í™•ì¸
- **ìˆ˜ìµë¥  ë¶„ë¦¬ ë¶ˆê°€ ì‚¬ìœ **: 
  1) ê³„ì¢Œ ë‚´ ë¡œë³´ ë¯¸ìš´ìš© ìì‚°(ì˜ˆê¸ˆ, ELB, ETF, ëŒ€ê¸°ìê¸ˆ ë“±)ì´ ì„ì—¬ ìˆì–´ ì •í™•í•œ ë¡œë³´ë§Œì˜ ìˆ˜ìµë¥  ì‚°ì¶œì´ ì–´ë ¤ì›€.
  2) ë¦¬ë°¸ëŸ°ì‹± ìŠ¹ì¸ ì‹œì  ë“± ê³ ê° ì˜ì‚¬ ê°œì…ì— ë”°ë¼ ì„±ê³¼ê°€ ë‹¬ë¼ì§€ë¯€ë¡œ í‘œì¤€ ìˆ˜ìµë¥  ì œê³µì´ ì–´ë ¤ì›€.
- **í™•ì¸ ë°©ë²•**: [MY ë¡œë³´ì–´ë“œë°”ì´ì € > ê³„ì¢Œí˜„í™© > ë³´ìœ í€ë“œ] ë©”ë‰´ì—ì„œ ê°œë³„ í€ë“œì˜ ìˆ˜ìµê¸ˆì•¡ìœ¼ë¡œ í™•ì¸ ê¶Œì¥.

### 6. ìƒì„¸ ì—ëŸ¬ ì‚¬ë¡€ (Error Case)
- **ì†Œìˆ˜ì  ë¬¸ì œ**: í‡´ì§ì—°ê¸ˆì—ì„œ ì†Œì•¡ íˆ¬ì ì‹œ ì •ìˆ˜ ë¹„ì¤‘ ì²˜ë¦¬ íŠ¹ì„±ìƒ 'ë§¤ë„ ìƒí’ˆ ì—†ìŒ' ì—ëŸ¬ ë°œìƒ.
- **ì¤‘ë³µ í”„ë¡œì„¸ìŠ¤**: 'í¬íŠ¸í´ë¦¬ì˜¤ ë³€ê²½ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤' íŒì—… ì‹œ ê¸°ì¡´ ë§¤ë§¤ í”„ë¡œì„¸ìŠ¤ê°€ ì„œë²„ì— ë‚¨ì•„ìˆëŠ” ê²ƒì´ë¯€ë¡œ, ì·¨ì†Œ í›„ ì¬ì‹œë„ í•„ìš”.
- **ê¸°ì¤€ì¼ì ë¯¸ì…ë ¥**: ë¡œë³´ì œì•ˆê³¼ ê³ ê°ì£¼ë„ ì„¤ê³„ê°€ ë™ì‹œì— ì¶©ëŒí•  ë•Œ ë°œìƒí•˜ëŠ” IT ì˜¤ë¥˜.
- **ë¯¸êµ­ êµ­ì ì**: ë¯¸êµ­ êµ­ì ìê°€ ì‚´ ìˆ˜ ì—†ëŠ” íŠ¹ì • í€ë“œê°€ í¬íŠ¸í´ë¦¬ì˜¤ì— í¬í•¨ë  ê²½ìš° ì„¤ê³„ ë‹¨ê³„ì—ì„œ ë©ˆì¶¤.
- **í‡´ì‚¬ í›„ DC**: í‡´ì‚¬ë¡œ ì¸í•´ ê³„ì¢ŒëŠ” íì‡„ë˜ì—ˆìœ¼ë‚˜ ê°€ì…ì ë²ˆí˜¸ê°€ ë‚¨ì€ ê²½ìš° í™”ë©´ì— ì§„ì…ë˜ì§€ë§Œ ì„¤ê³„ ì‹œ ì—ëŸ¬ ë°œìƒ.
"""

# 3. ëª¨ë¸ ì„¤ì • (Gemini 3 Flash ì‚¬ìš©)
# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— FAQ ë°ì´í„°ë¥¼ ì£¼ì…í•©ë‹ˆë‹¤.
system_prompt = f"""
ë‹µë³€ì˜ 1ìˆœìœ„ ê·¼ê±°ëŠ” ì œê³µëœ **[FAQ ë°ì´í„°]**ì…ë‹ˆë‹¤.
ë§Œì•½ FAQì— ì—†ëŠ” ë‚´ìš© ì¤‘ ì¼ë°˜ì ì¸ ê¸ˆìœµ ì§€ì‹ì€ ë‹¹ì‹ ì˜ ê¸°ë³¸ ì§€ì‹ì„ í™œìš©í•´ ì„¤ëª…í•˜ë˜, ë¯¸ë˜ì—ì…‹ì˜ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë‚˜ ì •ì±…ì€ ì¶”ì¸¡í•˜ì§€ ë§ˆì„¸ìš”.
ë¯¼ê°í•œ íˆ¬ì ê¶Œìœ  ì§ˆë¬¸ì—ëŠ” FAQì˜ ê³µì‹ ì…ì¥ì„ ì „ë‹¬í•˜ì„¸ìš”.
ì¼ë°˜ì ì¸ ì§€ì‹ì´ ì•„ë‹ˆê³ , [FAQ ë°ì´í„°]ì— ì—†ëŠ” ë‚´ìš©ì´ë¼ë©´ "ì£„ì†¡í•©ë‹ˆë‹¤. í•´ë‹¹ ë‚´ìš©ì€ ê³ ê°ì„¼í„°(1588-XXXX)ë¡œ ë¬¸ì˜ ë¶€íƒë“œë¦½ë‹ˆë‹¤"ë¼ê³  ë‹µë³€í•˜ì„¸ìš”."
[FAQ ë°ì´í„°]
{faq_data}
"""

model = genai.GenerativeModel(
    model_name="gemini-3-flash-preview",
    system_instruction=system_prompt
)

# 4. ì›¹ í™”ë©´ UI êµ¬ì„± (Streamlit)
st.set_page_config(page_title="ë¯¸ë˜ì—ì…‹ ë¡œë³´ ì±—ë´‡", page_icon="ğŸ¤–", layout="wide")

# ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜
with st.sidebar:
    st.title("ë©”ë‰´")
    selection = st.radio("ì´ë™í•  í˜ì´ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”:", ["ğŸ¤– ì±—ë´‡", "ğŸ“„ ë¦¬í¬íŠ¸ ë·°ì–´"])

if selection == "ğŸ¤– ì±—ë´‡":
    st.title("ğŸ¤– ë¯¸ë˜ì—ì…‹ ë¡œë³´ì–´ë“œë°”ì´ì € ìƒë‹´")
    st.caption("FAQ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ AIê°€ ë‹µë³€í•´ ë“œë¦½ë‹ˆë‹¤.")

    if "messages" not in st.session_state:
        st.session_state.messages = []

    # ê¸°ì¡´ ëŒ€í™” ê¸°ë¡ í‘œì‹œ
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥
    if prompt := st.chat_input("ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”"):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # AI ë‹µë³€ ìƒì„±
        with st.chat_message("assistant"):
            try:
                response = model.generate_content(prompt)
                st.markdown(response.text)
                st.session_state.messages.append({"role": "assistant", "content": response.text})
            except Exception as e:
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

elif selection == "ğŸ“„ ë¦¬í¬íŠ¸ ë·°ì–´":
    st.title("ğŸ“„ Macro Talking Point ë¦¬í¬íŠ¸ ë·°ì–´")
    st.caption("ê° ì§€ìˆ˜ì™€ ë‚ ì§œë³„ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    # ë¦¬í¬íŠ¸ íŒŒì¼ ìŠ¤ìº” í•¨ìˆ˜
    def get_reports():
        # í˜„ì¬ ë””ë ‰í† ë¦¬ì˜ html íŒŒì¼ ê²€ìƒ‰
        files = glob.glob("Macro Talking Point_ *.html")
        reports = []
        for f in files:
            # íŒŒì¼ëª… íŒŒì‹±: "Macro Talking Point_ {Index}_{Date}.html"
            # ì˜ˆ: "Macro Talking Point_ CPI_20251216.html"
            match = re.search(r"Macro Talking Point_ (.+?)_(\d+)\.html", f)
            if match:
                index_name = match.group(1)
                date_str = match.group(2)
                reports.append({
                    "filename": f,
                    "index": index_name,
                    "date": date_str,
                    "display": f"[{date_str}] {index_name}"
                })
        
        # ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        reports.sort(key=lambda x: x["date"], reverse=True)
        return reports

    reports = get_reports()

    if not reports:
        st.warning("í‘œì‹œí•  ë¦¬í¬íŠ¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        # 2ë‹¨ ë ˆì´ì•„ì›ƒ: ì„ íƒì°½ / ë·°ì–´
        col1, col2 = st.columns([1, 3])

        with col1:
            st.markdown("### ë¦¬í¬íŠ¸ ëª©ë¡")
            
            # 1. ì¹´í…Œê³ ë¦¬ í•„í„°ë§
            # ì „ì²´ ì¹´í…Œê³ ë¦¬ ì¶”ì¶œ ë° "ì „ì²´" ì˜µì…˜ ì¶”ê°€
            categories = sorted(list(set([r["index"] for r in reports])))
            categories.insert(0, "All")
            
            selected_category = st.selectbox("ì¹´í…Œê³ ë¦¬ ì„ íƒ:", categories)
            
            # ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì— ë”°ë¼ ë¦¬í¬íŠ¸ í•„í„°ë§
            if selected_category == "All":
                filtered_reports = reports
            else:
                filtered_reports = [r for r in reports if r["index"] == selected_category]
            
            # 2. ë¦¬í¬íŠ¸ ì„ íƒ
            if not filtered_reports:
                st.info("í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì— ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
                selected_report = None
            else:
                report_options = [r["display"] for r in filtered_reports]
                selected_option = st.radio("ë³´ê³  ì‹¶ì€ ë¦¬í¬íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”:", report_options)
                
                # ì„ íƒëœ ë¦¬í¬íŠ¸ ì •ë³´ ì°¾ê¸°
                selected_report = next((r for r in reports if r["display"] == selected_option), None)

        with col2:
            if selected_report:
                st.markdown(f"### ğŸ“‘ {selected_report['index']} ({selected_report['date']})")
                
                # HTML íŒŒì¼ ì½ì–´ì„œ í‘œì‹œ
                try:
                    with open(selected_report["filename"], "r", encoding="utf-8") as f:
                        html_content = f.read()
                    
                    # Streamlit ì»´í¬ë„ŒíŠ¸ë¡œ HTML ë Œë”ë§ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ë†’ì´ ì§€ì •)
                    components.html(html_content, height=800, scrolling=True)
                except Exception as e:
                    st.error(f"íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
